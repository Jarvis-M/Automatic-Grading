<!DOCTYPE html><!--声明文档类型为html5-->
<script>
    // =====================  part 1:全局配置   =======================
const CONFIG = {
    API_BASE_URL: 'http://localhost:5000', // 后端API地址(Flask默认端口)
    POLLING_INTERVAL: 2000, // 轮询间隔2秒
    MAX_POLLING_ATTEMPTS: 30 // 最多轮询30次
};


// ===================  part 2: 工具函数  ==============================
// 工具函数：显示消息
//function showMessage(message, type = 'info') {
//    // 在实际项目中可以替换为更美观的Toast组件
//    alert(`${type.toUpperCase()}: ${message}`);
//}

// 工具函数：显示警告弹窗
function showAlert(message) {
    // 创建遮罩层
    const overlay = document.createElement('div');
    overlay.className = 'alert-overlay';
    
    // 创建弹窗
    const modal = document.createElement('div');
    modal.className = 'alert-modal';
    modal.innerHTML = `
        <p>${message}</p>
        <button class="btn btn-primary" id="alertConfirmBtn">确认</button>
    `;
    
    // 添加到页面
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    
    // 确认按钮事件
    document.getElementById('alertConfirmBtn').addEventListener('click', () => {
        document.body.removeChild(overlay);
        document.body.removeChild(modal);
    });
    
    // 点击遮罩层也可以关闭
    overlay.addEventListener('click', () => {
        document.body.removeChild(overlay);
        document.body.removeChild(modal);
    });
}

// 工具函数：显示/隐藏元素
function toggleElement(elementId, show) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = show ? 'block' : 'none';
    }
}

//=======================  part3:页面功能  =============================

// 上传页面功能初始化
function initUploadPage() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const confirmBtn = document.getElementById('confirmBtn');
    const reuploadBtn = document.getElementById('reuploadBtn');
    const previewArea = document.getElementById('previewArea');
    const previewImage = document.getElementById('previewImage');
    const previewFilename = document.getElementById('previewFilename');
    const uploadStatus = document.getElementById('uploadStatus');
    const studentIdInput = document.getElementById('studentId');
    const navLinks = document.querySelectorAll('.nav-link');
    
    let selectedFile = null;

    // 为导航链接添加点击事件（防止未上传时跳转）
    navLinks.forEach(link => {
        if (link.getAttribute('href') === 'result.html') {
            link.addEventListener('click', (e) => {
                if (!selectedFile) {
                    e.preventDefault();
                    showAlert('请先上传图片');
                }
            });
        }
    });
    

    // 点击上传区域触发文件选择
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // 拖拽功能
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length) {
            handleFileSelect(e.dataTransfer.files[0]);
        }
    });

    // 文件选择变化
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // 处理选中的文件
    function handleFileSelect(file) {
        if (file && (file.type === 'image/jpeg' || file.type === 'image/png')) {
            selectedFile = file;
            
            // 显示预览
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewFilename.textContent = `文件: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                
                // 显示预览区域，隐藏上传提示
                toggleElement('uploadArea', false);
                toggleElement('previewArea', true);
            };
            reader.readAsDataURL(file);
            
            confirmBtn.disabled = false;
        } else {
            showMessage('请选择JPG或PNG格式的图片文件！');
        }
    }

    // 确认按钮点击 - 上传图片
    confirmBtn.addEventListener('click', async () => {
        if (!studentIdInput.value.trim()) {
            showAlert('请输入学号');
            return
        } 
        if(selectedFile){
            await uploadAndProcessImage(selectedFile,studentIdInput.value.trim());
        }else{
            showAlert('请先选择要上传的图片！');
        }
    });

    // 重新上传按钮
    reuploadBtn.addEventListener('click', () => {
        if(!selectedFile){
            showAlert('请先上传图片');
            return;
        }
        resetUploadState();
    });

    // 重置上传状态
    function resetUploadState() {
        fileInput.value = '';
        selectedFile = null;
        previewImage.src = '';
        
        toggleElement('uploadArea', true);
        toggleElement('previewArea', false);
        toggleElement('uploadStatus', false);
        
        confirmBtn.disabled = true;
        confirmBtn.textContent = '确认上传';
    }
    //格式化AI反馈为HTML
    function formatAIFeedback(apiResult){
        const breakdown = apiResult.score_breakdown;
        const rationale = apiResult.rationale;
        const suggestions = apiResult.suggestions;

        let feedbackHTML = `
        <h3>📊 评分细则</h3>
            <ul>
                <li><strong>可编译性：</strong>20/20分 - 代码一次性编译通过</li>
                <li><strong>正确性：</strong>35/40分 - 通过7/8个测试用例</li>
                <li><strong>代码质量：</strong>18/20分 - 结构清晰，命名规范</li>
                <li><strong>鲁棒性：</strong>8/10分 - 有基础异常处理</li>
                <li><strong>文档与可读性：</strong>4/10分 - 缺少必要注释</li>
            </ul>

            <h3>📝 评分理由</h3>
        <p>${rationale}</p>
        `;

        if (suggestions && suggestions.length > 0){
            feedbackHTML += `
                <h3>💡 改进建议</h3>
                <ul>
            `;
            suggestions.forEach(suggestions => {
                feedbackHTML += `<li>${suggestion}</li>`;
            });
            feedbackHTML += `</ul>`;    
        }

        return feedbackHTML;
    }
    async function realFetchResult(filepath, studentId) {
        //真实的获取AI评分
        try{
            const response = await fetch(`${CONFIG.API_BASE_URL}/ai_score`,{
                method: 'POST',
                headers:{
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filepath: filepath
                })
            });

            if(!response.ok){
                throw new Error(`获取评分失败: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            //根据后端返回格式处理
            if(result.score_breakdown){
                return{
                    student_id: studentId,
                    total_score: result.score_breakdown.total,
                    ai_feedback: formatAIFeedback(result)//格式化后端返回的数据
                };
            } else {
                throw new Error(result.error || '评分数据缺失');
            }
        } catch (error){
            console.error('获取评分API错误', error);
            throw error;
        }
        /** 
        return new Promise((resolve) => {
            setTimeout(() => {
                const result = {
                    student_id: studentId,
                    total_score: Math.floor(Math.random() * 30) + 70, // 70-100的随机分
                    ai_feedback: generateMockFeedback()
                };
                console.log(`模拟获取结果成功，taskId: ${taskId}, 学号: ${studentId}`);
                resolve(result);
            }, 3000);
        });
        */
    }
    // 后端上传
    async function realUploadToBackend(file,studentId) {
        const formData = new FormData();
        formData.append('file',file)
        //后端支持添加学号的话
        //formData.append('student_id', studentId)

        try{
            const response = await fetch(`${CONFIG.API_BASE_URL}/upload`,{
                method: 'POST',
                body: formData,
            });

            if (!response.ok){
                throw new Error(`上传失败:${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            //根据后端返回格式处理
            if(result.message && result.message.includes('successfully')){
                return result.filepath;//返回文件路径，用于后续AI评分
            }else{
                throw new Error(result.error || '上传处理失败');
            }
           
        } catch(error){
            console.error('上传API错误:', error);
            throw error;
        }
        /**模拟后端上传
         * return new Promise((resolve) => {
            setTimeout(() => {
                // 生成taskId
                const taskId = 'mock_task_' + Date.now();
                console.log(`模拟上传成功，文件名: ${file.name}, 学号: ${studentId}, taskId: ${taskId}`);
                resolve(taskId);
            }, 2000);
            });
            }
        **/
    }
    // 上传和处理图片
    async function uploadAndProcessImage(file,studentId) {
        try {
            // 显示上传状态
            toggleElement('uploadStatus', true);
            confirmBtn.disabled = true;
            confirmBtn.textContent = '处理中...';

            /**
             * // 模拟上传到后端（实际项目中替换为真实API调用）
            const taskId = await mockUploadToBackend(file,studentId);
            
            // 跳转到结果页面，传递taskId和studentId
            window.location.href = `result.html?task_id=${taskId}&student_id=${studentId}`;
             */
            
            //1.先上传文件
            const filepath = await realUploadToBackend(file, studentId);

            //2.然后获取AI评分
            const result = await realFetchResult(filepath,studentId);

            //3.跳转到结果页面，传递数据
            //由于数据较多，尝试使用URL参数传递基本信息，或者使用sessionStorage
            sessionStorage.setItem('gradingResult', JSON.stringify(result));
            window.location.href = `result.html?student_id=${studentId}`;

            
        } catch (error) {
            console.error('上传错误:', error);
            showAlert('处理失败：' + error.message);
            resetUploadState();
        }
    }

    // 初始状态禁用确认按钮
    confirmBtn.disabled = true;
}

// 结果页面功能初始化
function initResultPage() {
    const uploadAgainBtn = document.getElementById('uploadAgainBtn');
    const aiContent = document.getElementById('aiContent');
    const loadingContent = document.getElementById('loadingContent');
    const studentScore = document.getElementById('studentScore');

    /**
     * // 从URL获取
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('task_id') || 'demo_001';
        const studentId = urlParams.get(student_id) || '001';

        //立即更新学号显示（从URL参数获取）
        studentScore.textContent = `${studentId} - 加载中...`;

        // 获取评分结果
        fetchResult(taskId,studentId);

        // 获取结果
    async function fetchResult(taskId, studentId) {
        try {
            // 模拟从后端获取结果
            const result = await mockFetchResult(taskId, studentId);
            displayResult(result);
            
        } catch (error) {
            console.error('获取结果错误:', error);
            showAlert('获取评分结果失败');
            displayError();
        }
    }

     */
    
    //从sessionStorage获取结果
    const resultJson = sessionStorage.getItem('gradingResult');

    if(resultJson){
        const result = JSON.parse(resultJson);
        displayResult(result);
        //清除存储的数据
        sessionStorage.removeItem('gradingResult');
    }else{
        //如果没有数据，显示错误
        displayError('没有找到评分结果，请重新上传');
    }

    //再次上传按钮
    uploadAgainBtn.addEventListener('click', () =>{
        window.location.href = 'index.html';
    });


    // 显示结果
    function displayResult(result) {
        // 隐藏加载状态
        loadingContent.style.display = 'none';
        
        // 更新学号和分数
        studentScore.textContent = `${result.student_id} - ${result.total_score}分`;
        
        // 显示AI内容
        aiContent.innerHTML = result.ai_feedback;
    }

    // 显示错误状态
    function displayError(message) {
        loadingContent.innerHTML = `
            <div style="color: #e74c3c; text-align: center;">
                <p>❌ ${message}</p>
            </div>
        `;
    }

    // 获取结果


    /** 
    // 生成模拟的AI反馈
    function generateMockFeedback() {
        return `
            <h3>📊 评分细则</h3>
            <ul>
                <li><strong>可编译性：</strong>20/20分 - 代码一次性编译通过</li>
                <li><strong>正确性：</strong>35/40分 - 通过7/8个测试用例</li>
                <li><strong>代码质量：</strong>18/20分 - 结构清晰，命名规范</li>
                <li><strong>鲁棒性：</strong>8/10分 - 有基础异常处理</li>
                <li><strong>文档与可读性：</strong>4/10分 - 缺少必要注释</li>
            </ul>
            
            <h3>💡 改进建议</h3>
            <p>1. 代码逻辑清晰，但在边界条件处理上可以更加完善。</p>
            <p>2. 建议在关键函数前添加注释，说明其功能和参数。</p>
            <p>3. 第25行的循环可以优化，避免不必要的计算。</p>
            <p>4. 考虑使用更描述性的变量名，提高代码可读性。</p>
            <p>5. 可以添加更多的输入验证来增强程序的健壮性。</p>
        `;
    }
    */
}


//=======================  part4:页面初始化  ==========================
// 页面初始化
document.addEventListener('DOMContentLoaded', function(){
    // 根据当前页面初始化相应的功能
    if (document.querySelector('.upload-card')) {
        initUploadPage();
    }
    
    if (document.querySelector('.result-card')) {
        initResultPage();
    }
});
</script>
<html lang="zh-CN"><!--html根元素，设置语言为中文-->
<head>
    <meta charset="UTF-8"><!--设置字符编码为UTF-8-->
    <meta name="viewport"  content="width=device-width, initial-scale=1.0"><!--设置视口，使页面在移动端正确显示-->
    <title>C++作业批改系统 - 上传</title><!--页面标题-->
    <link rel="stylesheet" href="css/style.css"><!--引入外部css样式表-->
</head>
<body>
    <!-- 顶部导航栏-->
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">C++作业批改系统</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-link active">上传图片</a>
                <a href="resilt.html" class="nav-link">作业评分与建议</a>
            </div>
        </div>
    </nav>

    <!--主内容区-->
    <main class="main-container">
        <div class="upload-card">
            <h2>上传作业图片</h2>

            <!-- 添加学号信息 -->
            <div class="student-id-input">
                <label for="studentId">学号</label>
                <input type="text" id="studentId" placeholder="请输入学号">
            </div>

            <!--上传区域-->
            <div class="upload-area" id="uploadArea">
                <div class="upload-placeholder">
                    <span class="upload-icon">📁</span>
                    <p>点击或拖拽图片到此区域</p>
                    <p class="upload-hint">支持JPG\PNG 格式</p>
                </div>
                <input type="file" id="fileInput" accept=".jpg, .jieg, .png" hidden>
            </div>

            <!--图片预览区域-->
            <div class="preview-area" id="previewArea" style="display: none;">
                <img id="previewImage" src="" alt="预览图片">
                <p class="preview-filename" id="previewFilename"></p>
            </div>

            <!--按钮组-->
            <div class="button-group">
                <button class="btn btn-secondary" id="reuploadBtn">重新上传</button>
                <button class="btn btn-primary" id="confirmBtn">确认上传</button>
            </div>

            <!--上传状态-->
            <div class="upload-status" id="uploadStatus" style="display:none;">
                <div class="loading-spinner"></div>
                <span>正在上传和处理图片</span>
            </div>
        </div>
    </main>

    <script src="js/script.js"></script>
</body>
</html>    

<style>
    /* 基础样式重置 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f5f5f5;
    min-height: 100vh;
}

/* 顶部导航栏样式 - 根据要求调整 */
.navbar {
    background-color: rgba(190, 190, 190, 0.18); /* BEBEBE 18% 不透明度 */
    border: 1px solid #F8F9FA; /* 实线描边 */
    box-shadow: 0 1px 4px rgba(41, 47, 93, 0.1); /* 292F7D 10% 不透明度 */
    padding: 1rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
}

.nav-container {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-logo {
    font-size: 1.8rem; /* 主标题较大 */
    font-weight: bold;
    color: #2D305A; /* 2D305A 100% 不透明度 */
}

.nav-links {
    display: flex;
    gap: 3rem; /* 子标题间距 */
    margin-left: 2rem; /* 与主标题保持距离但挨着 */
}

.nav-link {
    color: rgba(41, 47, 93, 0.6); /* 292F7D 60% 不透明度 */
    text-decoration: none;
    padding: 0.5rem 0;
    position: relative;
    transition: all 0.3s;
    font-size: 1rem;
}

.nav-link:hover {
    color: rgba(41, 47, 93, 0.8);
}

.nav-link.active {
    color: rgba(41, 47, 93, 1);
    font-weight: 500;
}

/* 当前激活链接的下划线 */
.nav-link.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #292F7D;
}

/* 主容器 */
.main-container {
    width: 90%;
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
}

/* 卡片样式 */
.upload-card, .result-card {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* 上传页面标题 */
.upload-card h2 {
    margin-bottom: 1.5rem;
    color: #6C6C6C; /* 6C6C6C 100% 不透明度 */
    text-align: center;
    font-weight: bold; /* 加粗 */
}

/* 上传区域样式 */
.upload-area {
    border: 2px dashed #2196F3; /* 2196F3 100% 不透明度，虚线 */
    border-radius: 3px; /* 圆角3 */
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 1.5rem;
    background-color: #E3F2FD; /* E3F2FD 100% 不透明度 */
}

.upload-area:hover {
    border-color: #1976D2;
    background-color: #E3F2FD;
}

.upload-area.dragover {
    border-color: #1976D2;
    background-color: #BBDEFB;
}

/* 上传区域内部的框 */
.upload-placeholder {
    background-color: #FFFFFF; /* FFFFFF 100% 不透明度 */
    border: 1px solid #DCDCDC; /* DCDCDC 100% 不透明度，实线 */
    border-radius: 3px; /* 圆角3 */
    padding: 2rem;
    margin: 0 auto;
    max-width: 400px;
}

.upload-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.upload-hint {
    color: rgba(0, 0, 0, 0.4); /* 000000 40% 不透明度 */
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

/* 图片预览区域 */
.preview-area {
    text-align: center;
    margin-bottom: 1.5rem;
}

#previewImage {
    max-width: 100%;
    max-height: 300px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.preview-filename {
    margin-top: 0.5rem;
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* 按钮样式 */
.button-group {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.button-center {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: 1px solid; /* 线粗1 */
    border-radius: 4px; /* 圆角4 */
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
    flex: 1;
    font-weight: 500;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* 确认上传按钮 */
.btn-primary {
    background-color: #2196F3; /* 2196F3 100% 不透明度 */
    border-color: #2196F3; /* 2196F3 100% 不透明度，实线 */
    color: #FFFFFF; /* FFFFFF 100% 不透明度 */
}

.btn-primary:hover:not(:disabled) {
    background-color: #1976D2;
    border-color: #1976D2;
}

/* 重新上传按钮 */
.btn-secondary {
    background-color: #FFFFFF; /* FFFFFF 100% 不透明度 */
    border-color: #2196F3; /* 2196F3 100% 不透明度，实线 */
    color: #6C6C6C; /* 6C6C6C 100% 不透明度 */
}

.btn-secondary:hover {
    background-color: #F5F5F5;
}

/* 上传状态 */
.upload-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
    padding: 1rem;
    background-color: #e3f2fd;
    border-radius: 4px;
}

/* 结果页面标题 */
.result-header h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 2rem;
    font-size: 1.5rem;
    font-weight: 600;
}

/* AI内容区域 - 根据要求调整 */
.ai-content {
    background-color: #F0F9F2; /* F0F9F2 100% 不透明度 */
    border: 2px dashed #B5E3BF; /* B5E3BF 100% 不透明度，密虚线 */
    border-radius: 12px; /* 圆角12 */
    padding: 2rem;
    min-height: 300px;
    line-height: 1.8;
    box-shadow: 0 2px 6px 8px rgba(0, 0, 0, 0.4); /* 000000 40% 不透明度，X:0, Y:2, 模糊6, 扩散8 */
}

.ai-content h3 {
    color: #2c3e50;
    margin: 1.5rem 0 1rem 0;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
}

.ai-content h3:first-child {
    margin-top: 0;
}

.ai-content ul {
    margin-left: 1.5rem;
    margin-bottom: 1.5rem;
}

.ai-content li {
    margin-bottom: 0.5rem;
}

/* 加载动画 */
.loading {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 警告弹窗样式 */
.alert-modal {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 1.5rem;
    z-index: 1000;
    min-width: 300px;
    text-align: center;
}

.alert-modal p {
    margin-bottom: 1.5rem;
    color: #6C6C6C;
}

.alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 999;
}

/* 学号输入区域 */
.student-id-input {
    margin-bottom: 1.5rem;
}

.student-id-input label {
    display: block;
    margin-bottom: 0.5rem;
    color: #6C6C6C;
    font-weight: 500;
}

.student-id-input input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #DCDCDC;
    border-radius: 4px;
    font-size: 1rem;
}

.student-id-input input:focus {
    outline: none;
    border-color: #2196F3;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .nav-container {
        flex-direction: column;
        gap: 1rem;
    }
    
    .nav-links {
        margin-left: 0;
        gap: 1.5rem;
    }
    
    .button-group {
        flex-direction: column;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
    
    .upload-placeholder {
        padding: 1.5rem;
    }
    
    .main-container {
        width: 95%;
        margin: 1rem auto;
    }
    
    .ai-content {
        padding: 1.5rem;
    }
}
</style>
